---
output:
pdf_document: default
html_document: default
---

# Study designs in vaccine safety surveillance

In vaccine safety surveillance the researcher (or a defined automated system) observes, but does not intervene, with the events that occur. Therefore safety surveillance falls under observational studies. The researcher observes accumulating data related to vaccinations and medical diagnoses, and attempts to answer the question: has the rate of adverse events for a vaccinated individual increased due to the exposure. 

A natural follow-up question is: increased as compared to what? To answer this question, the researcher needs a *study design* which defines the groups of individuals to be compared. Ideally, the defined groups would only differ with respect to their exposure status, so that observed changes in the rates of events could be directly assigned to the exposure. In practise this is difficult to achieve.

Electronic health care data bases such as the hospital discharge register (HILMO) can be utilized as sources of data for the medical diagnoses used to operationalize the biological condition of interest (adverse event). However, the visit to a hospital resulting in a certain diagnosis code might not directly relate to the adverse event. This can introduce biases when comparing observations from different time periods, due to for example changes in diagnosis coding practises, which are then observed as changes in event rates. The chosen study design should be as robust to these changes as possible.  

If the study design is poor and the chosen groups are not comparable, the studied sample can be biased: the observed effect of the exposure can be caused by some other differences between the groups. This means that the rate of false positive or false negative signals generated by the safety surveillance method may be inflated.  

In their systematic review of vaccine safety surveillance applications, @Leite2016 found that from 11 recently generated signals, only 3 were confirmed as true signals. The false positive signals were assigned to 

1. Confounding factors that have not been considered
2. Misclassification of the outcome
3. Changes in the true incidence or coding practises
4. Inappropriate comparison groups
5. Uncertainty in background rates
6. Type I errors [@Leite2016 p. 234].

All the above reasons except the 2nd one are affected by the study design. 

In vaccine safety surveillance, the study design should make it unlikely to introduce biases while enabling the generation of a true signal as reliably as possible. In the following sections, I will first compare possible observational study designs for safety survaillance: Cohort designs, case-control designs and case-only designs. The rest of the chapter will then focus on the two most popular case-only study designs in pharmagovigilance (drug safety): the self-controlled case series (SCCS) and the case-crossover (CCO) desings.


## Observational epidemiological study designs

Ultimately all epidemiological study designs share the same goal: compare some group of individuals (cases or exposed) to another group of individuals (controls or unexposed). In vaccine safety surveillance, the question of interest is if and how the exposure to the vaccine causes an increased risk of an adverse event. The main observations of interest relate to medical diagnoses which occur after exposure. I will consider the following three observational study designs for safety surveillance:

1. **Cohort design**: Time is viewed from the point of view of exposure. Groups of exposed and non-exposed individuals are followed forward in time. The incidences of events are compared between the groups.
2. **Case-control design**: Time is viewed from the point of view of the event. Individuals with events (i.e. cases) are matched to one or more individuals without events (i.e. controls). The proportions of having been exposed are compared between the cases and controls.
3. **Case-only designs**: Only individuals with events are sampled and are self-matched, using for example risk and control intervals to define the events as either cases or controls. Event incidences or exposure rates are compared.  

The designs have different strengths and weaknesses, which are listed in table 2.1. 

```{r, echo = F, tab.cap = "Strengths and weaknesses of different epidemiological study designs."}
# designs
designs <- c("**Cohort design**", "**Case-control design**", "**Case-only design**")

strength_cohort <- "* Can provide an estimate of the baseline incidence \n * Utilizes all available data resulting in high power "
strength_case <-  "* If matched by age and time , controls for time-varying confounders such as age and seasonality \n* Needs little data specially with rare events "
strength_caseonly <- "* Self-controlled: eliminates selection biases and confounding related to control subjects and time-invariant characteristics. \n* Does not need a baseline incidence estimate \n* Needs only data on cases"

weakness_cohort <- "* If the exposure rate is high, the unexposed group from the same time period will be small \n * Confounders can affect the distribution of exposure, possibly resulting in bias"
weakness_case <- "* The unexposed group can be small \n * Finding suitable matches might be difficult \n * Confounders can affect the distribution of exposure, possibly resulting in bias"
weakness_caseonly <- "* The choice of the risk and control periods plays a crucial role  \n* Time-dependent confounders such as age and seasonality must be explicitly included in the model"

strengths <- c(strength_cohort, strength_case, strength_caseonly)
weaknesses <- c(weakness_cohort, weakness_case, weakness_caseonly)

# combine everything to a data frame and print with pander::pander
mytable = data.frame(
  Design     = designs,
  Strengths = strengths,
  Weaknesses = weaknesses)
pander::panderOptions("table.split.table", Inf)
pander::pander(mytable, keep.line.breaks = TRUE, style = 'grid', justify = 'left')
```

### Cohort and case-control designs

The cohort design utilizes all available data and is therefore often a preferred choice if data from the whole population is available. However, the nature of the exposure-event pairs considered here poses a problem to cohort designs. One problem is that the exposure to vaccination is optional, possibly resulting in selection bias. The second problem relates to using medical diagnoses as proxies for the underlying biological condition of interest. I will provide two examples to clarify. 

One way to utilize a cohort or a case-control design would be to compare the rates of events between the vaccinated and the not vaccinated populations of selected birth cohorts. This would provide a comparison which utilizes all available data from a single time period. The problem with this approach is that vaccination is both optional and usually very popular. Therefore, the group of unvaccinated individuals is often small and possibly biased due to selection. The latter may mean that the observed differences in the rates of events are due to the same reasons that cause individuals to become or not become vaccinated.    

A second example of a cohort design would be a comparison of full birth cohorts from the pre- and post eras of introduction of a new vaccine to a vaccination program. The pre-vaccination era could be used to estimate the baseline incidence and the incidence during the post era could then be compared against the baseline. This approach utilizes a lot of data and provides a seemingly unbiased comparison, assuming that exposure to vaccination is the only significant change between the different birth cohorts. The problem with this approach is that diagnosis coding practises can change over time due to changes in recommendations or practises. The observed differences in event rates in electronic health care data bases can therefore be simply due to these changes.  

### Case-only designs  

Case-only designs are designs which utilize data only from cases (persons with the events of interest). In case-only designs, each individual with an event acts as his/her own control and hence the designs are also called self-controlled designs. The designs considered here are based on comparison of event or exposure rates between defined risk and nonrisk periods.  

In self-controlled designs, comparisons are made within the individuals such that all time-invariant confounders are eliminated [@Nordmann2012]. Simulation studies by both @McClure2008 and @Glanz2006 have found that the self-controlled designs retain relatively high power compared to the cohort and case-control designs despite utilizing less data. 

In their systematic review of case-only designs, @Nordmann2012 found that the two most popular case-only designs utilized in pharmacovigilance are the case-crossover design (CCO) and the self-controlled case series design (SCCS). They also remark that "With the development of health care information technology .. these designs seem particularily appropriate to analyze pharmacovigilance data", assuming that the exposure is transient rather than chronic, such as vaccination.  

According to @Farrington2004, both CCO and SCCS can and have been used for vaccine safety analysis and according to @Maclure2012, they are better than cohort designs for investigating transient effects of vaccines.  

In the following sections, I will present the CCO and SCCS in detail. CCO and SCCS are suitable for studying rare adverse events for which a risk interval can be defined based on previous knowledge.

### CCO and SCCS  

The case-crossover design (CCO) and the self-controlled case series design (SCCS) are two of the most popular case-only designs. Both designs implicitly or explicitly define risk and control periods during which rates of events are of interest. The risk period is a time interval following exposure during which the incidence rate of the adverse event can be thought of being potentially related to the exposure. A control period consists of one or more time intervals during which the incidence rate is assumed to be according to the normal background rate of the individuals 

- **The case-crossover design** (CCO): A case-only study design derived from a case-control design logic. Time is viewed from the point of view of the event. The random variables analysed are retrospectively ascertained exposures.
- **The self-controlled case series design** (SCCS) A case-only study design derived from a cohort design logic. Time is viewed from the point of view of the exposure. The ages at vaccination are regarded as fixed, and the random variable of interest is age at event, conditionally on its occurrence within a pre-determined observation period. [@Farrington2004]  

In CCO and SCCS, events occuring during the risk period can be labeled as "cases" and events during the control period as "controls." Individuals act as both cases and controls in the study because the person time of the individuals is used to define both the cases and the controls. Both designs aim at comparing the incidence rates of the adverse events between the risk and control periods.  

From a statistical inference point of view, incidence rates can be compared with their ratio, called the *rate ratio*, denoted by $RR$. The rate ratio between two constant incidence rates $\lambda_1$ and $\lambda_0$ is

\begin{equation}
RR = \frac{\lambda_1}{\lambda_0}.
\end{equation}

The rate ratio is the parameter of interest in both designs. The SCCS aproaches the problem by directly considering the rates of events during the different periods of risk. CCO approaches the problem "backwards" by considering the rates of exposure instead. In SCCS the rate ratio can be directly estimated and in CCO it can be approximated with the odds ratio of exposure.  

What follows is a detailed description of the SCCS method followed by a description of the probability model of the CCO, where I will further discuss the relationship of the rate ratio, risk ratio and exposure odds ratio in CCO and case-control studies in general.

## The self-controlled case-series design (SCCS)

I will now present the self-controlled case series design (SCCS) developed by @Farrington1995. In SCCS the goal is to compare the relative rates of adverse events during disjoint risk and control time periods, specified in relation to the time of vaccination. The effect of the vaccination is estimated via the rate ratio $RR = \lambda_1 / \lambda_0$, where in a simple case  

- $\lambda_1$: event incidence during a period when the exposure to vaccination is assumed to have an effect (risk period)
- $\lambda_0$: event incidence during a period when the vaccination is assumed to not have an effect (control period).

If there is a significant change in the incidence during the risk period, the rate ratio will significantly differ from 1, with values greater than 1 indicating a positive association between the exposure and the event. The risk period be a period of two weeks immediately following vaccination. A control period can also be explicitly defined, or alternatively all other time during the observation period can be considered as the control period. See Figure \ref{fig:simpleSCCS} for an illustration of the former.  

```{r echo = FALSE, fig.width = 10, fig.height = 4, fig.align = "center", out.width= "350px", fig.cap = "\\label{fig:simpleSCCS}A simple example of a SCCS design where the period immediately following exposure is defined as the risk period with length $t_1$ and a time period following the risk period is defined as the control period with length $t_0$."}

library(pBrackets)
par(mar = c(3, 4, 4, 4), oma = c(2,0,0,2))
x <- 0:90
plot(x,x, type = "n", yaxt = "n", ylab = "", xaxt = "n", main = "A simple Self Controlled Case Series design", 
     bty = "n", xlim = c(0, 120))
axis(1, labels = F, at = c(-20, 150))
h <- 5
v<- 35
rect(v, h, v+14, h + 15, col = "grey50", lwd = 0)
rect(v+14, h, v+14+30, h + 15, col = "grey80", lwd = 0)
lines(x = c(v,v), y = c(-10, h + 25), lty = 1, col = "red")
lines(x = c(v+10,v+10), y = c(-10, h + 25), lty = 2, col = "blue")
mtext(side = 1, "age of individual", line = 1)

brackets(v, h + 16, v + 14, h + 16, xpd = T); text(x = v + 7, y = h + 31, labels = "t_1")
brackets(v+14, h + 16, v + 14 + 30, h + 16, xpd = T); text(x = v + 14 + 15, y = h + 31, labels = "t_0")
legend("topright", 
       legend = c("exposure", "event", "risk period", "control period"), 
       fill = c(NA, NA, "grey50", "grey80"), lty = c(1,2, NA, NA), col = c("red", "blue"),
       border = NA, merge = T)
```

The general idea of SCCS is to describe the event incidence as a function of the (constant) individual baseline incidence, effects due to vaccine exposure and other possible time-dependent factors such as age. Statistical inference in SCCS is based on a conditional likelihood which removes the individual incidence nuissance parameter. Inference concerning relative incidences (rate ratios) can therefore be done "within individuals" so that the individual baseline incidences have no effect on the inference. 

In what follows is a mathematical description of SCCS largely inspired by the description of the general SCCS given in the case series tutorial by @Whitaker2006 [pp. 9-10] with influences from the description of SCCS by @Bernardo2011 [pp. 10-12]. I will first give a general framework for the SCCS method by introducing the concept of a Poisson incidence function and the conditional likelihood for the parameters of that function. I will then proceed to present a simple version of the SCCS design, which I will call the simple SCCS, where interest is to quantify the relative incidence of adverse events during a specified risk and control period. I will then describe the general SCCS, which allows for inference regarding multiple risk periods and age. 

### Poisson process  

An underlying assumption in the SCCS method is that adverse events occur as a Poisson process. A poisson process describes the probabilities for the numbers of events during some time interval(s). An important assumption related to the Poisson process is that the random variables corresponding to these numbers of events are independent. This implies that an occurrence of an adverse event should not influence the probabilities of future adverse events. This assumption is likely to be violated in practise, but if the event is rare (relative to the length of the observation period), then this violation is unlikely to have practical consequences.    

HUOM
\begin{definition}[Poisson process]
\label{poissonprocess}
Let $D$ be the time period of interest and $d$ disjoint subsets of $D$. Let $Y_d$ denote the number of events during $d$ with $E[Y_d] = \lambda_d$. A Poisson process is defined by the following assumptions:  \\[10pt]
1. The random variables $Y_d$ are independent \\[4pt]
2. The point probabilities for the number of events are given by the Poisson distribution:
$$
y_d \sim Poi(\lambda_d) \Leftrightarrow P(Y_d = y_d) = \frac{\lambda_d^{y_d} \cdot e^{-\lambda_d}}{y_d !}
$$
\end{definition}

### Incidence function  

The observation period in SCCS is the calendar- and age period during which individuals can be sampled as cases. An assumption is made that during this observation period, adverse events for individuals $i = 1, 2, ..., N$ arrive as a non-homogenous piecewise-constant Poisson process. What this means is that while the intensity of the process can vary, it remains constant for each of the disjoint intervals of the oservation period. In this work the smallest measurable unit for time is a day, since data in electronic health care data bases such as AvoHILMO is collected daily. For each individual, I will index the observation period by days denoted by $d$. 

The rate of the adverse events during each day for each individual depends on the idividual intensity of the Poisson process during that day. The incidence is assumed to be constant within each day, but can vary between days. The intensity during day $d$ for individual $i$ is given by the incidence function $\lambda_{id}$, which depends on a constant individual effect $\phi_i$ and a time-dependent effect $\boldsymbol\theta$. The latter captures exposures to vaccination and changes in age. The effect of each $\theta_d$ is assumed to be multiplicative, so that the incidence function for individual $i$ during day $d$ is given by

\begin{equation}
\lambda_{id} = exp(\phi_i + \theta_d).
\end{equation}

Due to the properties of the Poisson process the cumulative incidence over a number of days during the observation period is a sum of the daily incidences. If the incidence stays constant for a period of consequent, say, $t_q$ days, the incidence during that period is given by the number of days times the daily incidence. Assuming that the observation period consists of such disjoint periods, the incidence function is then given by

\begin{equation}
\label{incfunc}
\lambda_{iq} = t_q \cdot exp(\phi_i + \theta_q),
\end{equation}

where $\theta_q$ is the constant $\theta_d$, for the all $d$ days in period $q$.

For example in a simple case as in figure (\ref{fig:simpleSCCS}), where $q \in \{\text{risk period}, \text{control period}\}$, the incidence function takes on two different values.

### Likelihood

Assume now that events of $i = 1, 2, ..., N$ individuals are sampled, with $n_i \geq 1$ events for each $i$ for a total of $n$ events. Assume that the observation period is as described above and that events arrive as a Poisson process with an incidence function as defined in (\ref{incfunc}). Denote the number of events for individual $i$ during period $q$ as $y_{iq}$. The probabilities for the numbers of events during the disjoint intervals $q$ are given by the Poisson distribution: $y_{iq} \sim Poi(\lambda_{iq})$. The individual contribution to the likelihood for the observations is therefore  

\begin{equation}
L_i(\boldsymbol\theta) 
= P(\boldsymbol{y}_i \mid \phi_i,  \boldsymbol\theta) 
= \prod_q P(y_{iq} \mid \phi_i, \theta_q) 
\propto \exp\{- \sum_q \lambda_{iq}\} \prod_q (\lambda_{iq})^{y_{iq}},
\end{equation}

where $\lambda_{iq} = t_q \cdot exp(\phi_i + \theta_q)$ as in (\ref{incfunc}). The likelihood contains the individual baseline incidence $\phi_i$ which is a nuisance parameter, since the real interest is in the effect of the vaccination and/or age, captured by $\boldsymbol\theta$.  

The total number of events for the individual $n_i = \sum_q y_{iq}$ turns out to be a sufficient statistic for $\phi_i$, meaning that conditioning on $n_i$ removes the dependency on $\phi_i$. It is therefore convenient to operate with the conditional likelihood instead. Since the random variable corresponding to the total number of events is a sum of Poisson random variables, it is also Poisson distributed $n_i \sim Poi(\sum_q \lambda_{iq})$. The individual contribution to the conditional likelihood is

\begin{equation}
\label{condlik}
L_i(\boldsymbol\theta \mid n_i) 
= P(\mathbf{y}_i \mid n_i, \phi_i, \boldsymbol\theta)  
= \frac{P(\mathbf{y}_i \mid \phi_i, \boldsymbol\theta) }{P(n_i \mid \phi_i, \boldsymbol\theta)} 
\propto \frac{\prod_q \lambda_{iq}^{y_{iq}}}{\left( \sum_q \lambda_{iq} \right) ^{\sum_q y_{iq}}}
= \prod_q \left( \frac{ \lambda_{iq} }{ \sum_{q'} \lambda_{iq'}) } \right)^{y_{iq}}
\end{equation}

Now, plugging in the actual incidence function (\ref{incfunc}), the conditional likelihood is

\begin{equation}
L_i(\boldsymbol\theta \mid n_i) 
\propto \prod_q \left( \frac{ t_q \cdot e^{\phi_i} \cdot e^{\theta_q}}{ \sum_{q'} t_{q'} \cdot e^{\phi_i} \cdot e^{\theta_{q'}}} \right)^{y_{iq}}
= \prod_q \left( \frac{t_q \cdot e^{\theta_q}}{\sum_{q'} t_{q'}  \cdot e^{\theta_{q'}}} \right)^{y_{iq}},
\end{equation}

which is a multinomial likelihood where the individual baseline incidences have been canceled out. This means that using the conditional likelihood, the inference concerning the parameter $\boldsymbol\theta$ cannot be influenced by the individual incidences $\phi_i$. In that sense the SCCS design is self-controlled. However, it should be noted that all factors which depend on the time period $q$, such as age, remain. The effect of age can be separately included in the model in the general version of SCCS.

Next I will present the simple SCCS and the general SCCS which are both based on the assumptions of a piecewise-constant Poisson process and a conditional likelihood. The simple SCCS is particularily useful for the safety surveillance method BmaxSPRT, to be introduced later. The general SCCS is relevant for future research in developing safety surveillance methods.  

### Simple SCCS \label{section:simpleSCCS}

Consider a SCCS with a simple incidence function where there are two periods of interest: a risk period and a reference control period. Denote these periods by the indicator $k \in \{0, 1\}$ where $1$ indicates a risk period and $0$ indicates a reference control period. 

The risk and control periods are disjoint and of lengths $t_1$ and $t_0$ respectively, and are defined in relation to the time of exposure to vaccination. For example, a time period immediately following vaccination can be defined as a risk period and a time period following the risk period can be defined as a control period, as illustrated in Figure \ref{fig:simpleSCCS}. The incidence function (\ref{incfunc}) takes the form

\begin{equation}
\lambda_{ik} = t_k \cdot exp(\phi_i + \psi_k), \quad k = 0, 1.
\end{equation}

Assume that during the control period $\psi_0 = 0$ and the incidence is simply determined by the baseline incidence of the individual $t_0 \cdot e^{\phi_i}$. The parameter of interest is $\psi_1$ which quantifies the multiplicative effect that the risk period has on the incidence and during the risk period the incidence is given by $t_1 \cdot e^{\phi_i} e^{\psi_1}$. Then, $RR = \lambda_{i1} / \lambda_{i0} =  e^{\psi_1}$ is the common rate ratio of the incidence between the risk and control periods.  

Now assume that the observation period is as described earlier and assume again that events of $i = 1, 2, ..., N$ individuals are sampled, with $n_i \geq 1$ events for each $i$ for a total of $n$ events. Denote the number of events for individual $i$ during the risk period as $y_{i1}$ and during the control period as $y_{i0}$. The individual contribution to the conditional likelihood (\ref{condlik}) for the parameter $\psi_1$ is

\begin{equation}
L_i(\psi_1 \mid n_i) 
\propto
\prod_{k = 0,1} \left( \frac{t_k \cdot e^{\psi_k}}{\sum_{k'} t_{k'}  \cdot e^{\psi_{k'}}} \right)^{y_{ik}}
= \left( \frac{ e^{\psi_1} }{ e^{\psi_1} + t_0/t_1 } \right) ^{y_{i1}} 
 \left( \frac{ t_0 / t_1 }{ e^{\psi_1} + t_0/t_1 } \right)^{n_i - y_{i1}}.
\end{equation}

which is the binomial likelihood, where the only unknown parameter is the common rate ratio $RR = e^{\psi_1}$. If one labels the events that occured during the risk interval as "cases", and the events that occured during the control interval as "controls", the probability of an event labeled as a case depends only on $RR$ and the ratio of the lengths of the two periods $z = t_0 / t_1$.  The probabilities of a "case" ("success") and "control" ("failure") are given by 

\begin{equation}\label{eq:p}
P("case") = p = \frac{RR}{RR + z}, \quad P("control") = 1-p = \frac{z}{RR + z}.
\end{equation}

Assuming that individuals are independent, the total conditional likelihood can be seen as independent binomial trials with a homogenous probability of success, $p = RR / (RR + z)$. Given that observations included $y_1 = \sum_i y_{i1}$ "cases", the total conditional likelihood for the parameter $RR$ is  

\begin{equation}\label{eq:SCCS-binomial}
L(RR \mid n) = P(y_1 \mid RR, n) \propto \left( \frac{RR}{RR + z} \right)^{y_1} \left( \frac{z}{RR + z}\right)^{n - y_1}.
\end{equation}

### General SCCS

I will now present a more general version of SCCS, including an age effect parameter and multiple risk intervals with varying risks. Varying risks can be motivated by for example the desire to include the effects of different doses of a vaccine. The inclusion of an age effect is motivated by the fact that many biological conditions are age-dependent.  

Concider an observation period as described earlier and assume that adverse events arrive as a piecewise-constant Poisson process with an incidence function similar to (\ref{incfunc}). The observation period for each individual is split into disjoint intervals by age groups denoted by $\gamma_j$ and disjoint risk periods denoted by $\psi_k$. The number of days in an interval where $i$ is in age group $j$ and risk period $k$ is denoted by $t_{ijk}$. The incidence function for $i$ can then be written as 

\begin{equation}
\lambda_{ijk} = t_{ijk} \cdot exp(\phi_i + \gamma_j + \psi_k),
\end{equation}

where for the reference age group $\gamma_0 = 0$ and for the reference risk period (control period) $\psi_0 = 0$. Now denote the number of events observed during each interval by $y_{ijk}$. The individual contribution to the conditional likehood (\ref{condlik}) is

\begin{equation}
L_i(\boldsymbol\psi, \boldsymbol\gamma \mid n_i) 
\propto
\prod_{jk} \left( \frac{t_{ijk} \cdot e^{\gamma_j}\cdot e^{\psi_k}} {\sum_{j'k'} t_{{ij'k'}} \cdot e^{\gamma_{j'}} \cdot e^{\psi_{k'}}} \right)^{y_{ijk}}.
\end{equation}

Assuming that individuals are independent, the total conditional likelihood is

\begin{equation}
L(\boldsymbol\psi, \boldsymbol\gamma \mid n_i) 
\propto
\prod_i\prod_{jk} \left( \frac{t_{ijk} \cdot e^{\gamma_j}\cdot e^{\psi_k}} {\sum_{j'k'} t_{{ij'k'}} \cdot e^{\gamma_{j'}} \cdot e^{\psi_{k'}}} \right)^{y_{ijk}},
\end{equation}

which, again, is the multinomial likelihood where all the individual baseline incidences have been cancelled out.

## The case-crossover design (CCO)

The most popular case-only design utilised in pharmacovigilance is the case-crossover design (CCO). CCO is a modification of a case-control design, originally developed by @Maclure1991 to study the effect of transient exposures to acute events. Its use in drug safety studies has increased during 2000-2010 [@Nordmann2012].  

Following the description of @Maclure2012, one way to describe the CCO design is as follows: Assume that rare events are observed for individuals $i = 1, .., n$. Each event occurs during some *event day*. A *control day* is defined as the day that was $d$ time units (e.g. days) before the event day. For each sampled individual $i$, exposure status is retrospectively examined. Exposures during a time interval of length $t$ immediately preceding the event day are considered as related to the event. Exposures occuring during a time interval of the same length ($t$) immediately preceding the control day are considered as not related to the event.

The periods where the exposure status is of interest are sometimes called risk and control periods in CCO literature, but I will call these periods the *related period* and the *non-related period*, respectively, in order to avoid confusion with the risk and control periods of the SCCS design, where the risk period is a time period during which the rate of events (not exposures) is of interest. The idea of the CCO method is to compare the rates of exposure between the related and the non-related periods. This description of CCO is illustrated in Figure \ref{fig:simpleCCO}.  

```{r, echo = FALSE, fig.width = 10, fig.height = 4, fig.align = "center", out.width= "350px", fig.cap = "\\label{fig:simpleCCO}A graphical illustration of the CCO design. Exposures occuring immediately before the event day are considered as related to the event and exposures occuring immediately before the control day are considered as not related to the event."}

library(pBrackets)
par(mar = c(3, 4, 4, 4), oma = c(2,0,0,2))
x <- 0:90
plot(x,x, type = "n", yaxt = "n", ylab = "", xaxt = "n", main = "A simple Case-crossover design", 
     bty = "n", xlim = c(0, 120))
axis(1, labels = F, at = c(-20, 150))
h <- 5
e<- 70
lines(x = c(e,e), y = c(-10, h + 25), lty = 1, col = "blue")
lines(x = c(e-15,e-15), y = c(-10, h + 25), lty = 2, col = "blue")
rect(e, h, e-14, h + 15, col = "grey50", lwd = 0)
rect(e-15, h, e-15-14, h + 15, col = "grey80", lwd = 0)

mtext(side = 1, "age of individual", line = 1)

#brackets(v, h + 16, v + 14, h + 16, xpd = T); text(x = v + 7, y = h + 31, labels = "t_r")
#brackets(v+14, h + 16, v + 14 + 30, h + 16, xpd = T); text(x = v + 14 + 15, y = h + 31, labels = "t_c")

legend("topright", 
       legend = c("event day", "control day", "related period", "non-related period"), 
       fill = c(NA, NA, "grey50", "grey80"), lty = c(1,2, NA, NA), col = c("blue"),
       border = NA, merge = T)

```

The description given above follows the so-called retrospective conditional argument of case-control studies. In the retrospective probability model, the exposures are conditioned by the case or control status and the odds ratio of exposure between different event status ("case" or "control") is the parameter of interest. The estimation of disease-exposure relationship in case-control studies may however also be approached using a prospective conditional argument. In the prospective probability model, the event status is conditioned on the exposure and the odds ratio of the event status between levels of exposure is estimated [@ClaytonHills, ch. 16].  

From a prospective point of view, a time interval $[t_0, t_1]$ following exposure is called the *effect period* in CCO literature, during which the rate of events for the exposed individuals is possibly increased. The effect period is comparable to the risk period of the SCCS design and thus I will use the term risk period to refer to the effect period. I will also refer to the time outside the risk period as the control period, as in SCCS.  

CCO is interested in the same question as SCCS, which is to infer if the rate of events is affected by exposure. Even though the method is based on the idea of exposures as the random variable, the parameter of interest can be defined as any of the prospective relative risk parameters: the odds ratio, relative risk or the incidence rate ratio [@Nordmann2012 p.8]. In what follows, I will introduce the probability model and assumptions of the CCO design in more detail by treating the desing in the general framework for case-control studies following the presentation of @ClaytonHills [ch. 16].

### The probability model for CCO  

Assume that we have sampled individuals who each experienced at least one of the events of interest. The date of the events is labeled as the event day. Define a control day as the day that was $d$ time units (e.g. days) prior to the event day $d$. The control day could for example be two weeks and one day before the event day. Also define the related and the non-related periods, or equivalently the risk and the nonrisk risk periods, both of length $t$ days. For example, the risk period could be a period of two weeks following vaccination, in which case the related period is the period two weeks prior to the event day. Then, the non-related period is the period two weeks prior to the control day. See again Figure \ref{fig:simpleCCO} for an illustration.  

To set up the notation, denote the probabilities of the occurrence of an adverse event in individual $i$ during the risk and controls periods as $P(AE_1) = \pi_{i1}$ and $P(AE_0) = \pi_{i0}$, respectively. Denote the random variable corresponding to being vaccinated during the related period by $V_{i1}$ and during the non-related period by $V_{i0}$.  

Now assume that in the underlying cohort (the study base), exposure to vaccination for each individual is equally likely during both the related and non-related periods. The random variables $V_{i.}$ are then Bernoulli random variables with equal probabilities of success $P(V_{i1}) =  P(V_{i0}) = p_i$. Note, however the distinction to the conditional probabilities $P(V_{i.} \mid AE)$ which are not assumed to be equal.  

To solve the probability that an individual who experienced an event was vaccinated during the related period, notice that this sequence of events requires that an individual was first vaccinated and then experienced an event during the risk period. Therefore, the probability is given by $p_i \cdot \pi_{i1}$. Similarily, the probability that an individual with an event was vaccinated during the non-related period is given by $p_i \cdot \pi_{i0}$.  This is illustrated in figure \ref{cco_probmodel}. These probabilities define a joint probability model for the vaccination status and the (adverse event) outcome.  

HUOM
```{r cco_probmodel, message = F, fig.cap = "\\label{cco_probmodel}The probability model in the study base for the case-crossover design, where only individuals with events (AE) are considered. An individual is first either vaccinated (V+) with probability P(V) or not vaccinated (V-). If she was vaccinated, the AE she experienced happened during a risk period with probability P(AE_1) or a control period with probability P(AE_0). If she was not vaccinated the AE happened with probability P(AE_0)"}

plot.probtree <- function(nodes, edges, labels, attributes = list(node=list(label="foo", fillcolor="grey85", fontsize="11"),
                                                                 edge=list(color="black", fontsize = "9"), graph=list(size = "6.00,5.00",rankdir="LR"))) {
  require("Rgraphviz")
  rEG <- new("graphNEL", nodes=nodes, edgemode="directed")
  for(edge in split(edges, rep(1:(length(edges)/2), each = 2))) {
    rEG <- addEdge(nodes[edge[1]], nodes[edge[2]], rEG, 1)
  }
  plot(rEG, edgeAttrs=list(label=setNames(labels, edgeNames(rEG))), attrs=attributes)
}
i <- "i"
V<-"V+"
notV<-"V-"
AE_r<-"AE_1"
AE_c<-"AE_0"
AE <- "AE"
nodes1 <- c(i, V, notV, AE_r, AE_c, AE)
edges1 <- c(1,2,1,3,2,4,2,5,3,6)
labels1 <- c("P(V)", "1 - P(V)", "P(AE_1)", "P(AE_0)", "P(AE_0)")

plot.probtree(nodes1, edges1, labels1)

```

Using the probability model for the CCO, I will next derive equations for the odds ratio of exposure between the related and non-related periods and discuss its relationship to the risk ratio and rate ratio.  

### The odds ratio and risk ratio

Based on the joint probability model of the vaccination status and the adverse event, define $O_1$ as the odds of vaccination during the related period and $O_0$ as the odds of vaccination during the non-related period.

HUOM
\begin{equation}
O_1 = \frac{p_i \cdot \pi_{i1}}{(1-p_i) \cdot \pi_{i0}}, \quad O_0 = \frac{p_i \cdot \pi_{i0}}{(1-p_i) \cdot \pi_{i0}}.
\end{equation}

Then, the odds ratio (OR) of vaccination between the related and non-related periods is 

\begin{equation} \label{eq:OR-CCO}
OR_i = \frac{O_1 }{O_0} =  \frac{p_i \cdot \pi_{i1}}{(1-p_i) \cdot \pi_{i0}} \cdot \frac{(1-p_i) \cdot \pi_{i0}}{p_i \cdot \pi_{i0}} = \frac{\pi_{i1}}{\pi_{i0}}.
\end{equation}

The underlying probability of exposure is canceled out and the odds ratio is seen to be equivalent to the risk ratio of the event occurrance between the risk and control periods, defined as $\pi_{i1} /\pi_{i0}$. When the probability of the event occurance is small (rare event), this ratio is also approximately equal to the event rate ratio [@ClaytonHills, ch. 16].  

There is no analytical solution to the likelihood equations of the CCO design. In his original paper, Maclure suggests using the Mantel-Haenzel estimator to approximate the rate ratio parameter. Further discussion of maximum likelihood estimation in the CCO setting is provided by Marshall and Jackson [@Marshall1993]. 


### CCO in the literature

The literature concerning the CCO approach can be confusing, since it must be interpret from context if the author has chosen to treat the design from a prospective or retrospective point of view and sometimes both views are used simultaneously. For example, @Nordmann2012 [p. 2] describe the method using phrasing *"With this design, the probability of exposure in the risk period is compared to the probability of exposure in control period(s)."*. They however then go on to state that *"same probability of event occurrence during case and control periods"* is a major assumption of the method.  

When discussing CCO, @Farrington2004 writes that *"the underlying probability of vaccination should be the same in all intervals"*, HUOM which from equation (\ref{eq:OR-CCO}) can be seen is a necessary condition for the fact that the odds ratio of exposure and the odds ratio of event status are equal. @Farrington2004 [p. 2066] then adds that this assumption *"is unlikely to hold for paediatric vaccines administered according to stricter schedules"*.  

## Study design conclusions

Case-only designs are attractive for vaccine safety surveillance mainly because they implicitly control for time-invariant confounders. However, it remains important to control for time-varying confounders such as age and seasonality [@Farrington2004, *Introduction*]. 

Of the two most popular case only designs, the SCCS compares somewhat favourably to CCO. The SCCS allows for direct inference concerning the population parameter of interest, which is the rate ratio of adverse events between specified risk and control time periods. @Farrington2004 [p. 2066] has also pointed out that in the case of paediatric vaccines there is at least a conceptual problem with the CCO design, where the idea is to treat vaccination times as random variables. It is more natural to view the event times as the random variables of interest as in SCCS, since vaccinations often occur according to a strict schedule. 

The simple SCCS introduced in \ref{section:simpleSCCS} offers a statistical model where the rate ratio $RR$ is the only unknown parameter and fixed individual covariates have no effect on the inference. The following chapter continues discussion of safety surveillance from the point of view of the decision element. The simple SCCS is adopted as the design element.
